#@tool
extends Node

var room_name = "title"

@export var title_scenes: Array[PackedScene]

#var moon = preload("res://objects/other/intro/moon/moon.tscn")
#var intro_bg = preload("res://objects/other/intro/intro_bg/intro_bg.tscn")
#var palm_tree_dark = preload("res://objects/other/intro/palm_tree_dark/palm_tree_dark.tscn")
#var cave_bg2 = preload("res://objects/blocks/cave_bg2/cave_bg2.tscn")
#var cave_bg_entrance = preload("res://objects/blocks/cave_bg_entrance/cave_bg_entrance.tscn")
#var shrub_dark = preload("res://objects/other/intro/shrub_dark/shrub_dark.tscn")
#var desert = preload("res://objects/other/intro/desert/desert.tscn")
#var dark = preload("res://objects/blocks/dark/dark.tscn")
#var desert2 = preload("res://objects/other/intro/desert2/desert2.tscn")
#var desert_top = preload("res://objects/other/intro/desert_top/desert_top.tscn")
#var intro = preload("res://objects/intro/intro.tscn")
#var bricks = preload("res://objects/bricks/bricks.tscn")
#var game = preload("res://objects/game/game.tscn")
#var bat_intro = preload("res://objects/other/intro/bat_intro/bat_intro.tscn")

var title_bg = preload("res://objects/other/title/title_bg/title_bg.tscn")
var x_start = preload("res://objects/other/title/x_start/x_start.tscn")
var x_scores = preload("res://objects/other/title/x_scores/x_scores.tscn")
var x_shortcut5 = preload("res://objects/other/title/x_shortcut5/x_shortcut5.tscn")
var x_tutorial = preload("res://objects/other/title/x_tutorial/x_tutorial.tscn")
var quit_sign = preload("res://objects/other/title/quit_sign/quit_sign.tscn")
var scores_sign = preload("res://objects/other/title/scores_sign/scores_sign.tscn")
var start_sign = preload("res://objects/other/title/start_sign/start_sign.tscn")
var level5_sign = preload("res://objects/other/title/level5_sign/level5_sign.tscn")
var tutorial_sign = preload("res://objects/other/title/tutorial_sign/tutorial_sign.tscn")
var rope = preload("res://objects/items/rope/rope.tscn")
var brick_smooth = preload("res://objects/blocks/brick_smooth/brick_smooth.tscn")
var brick = preload("res://objects/blocks/brick/brick.tscn")
var hard_block = preload("res://objects/blocks/hard_block/hard_block.tscn")
var title_logo = preload("res://objects/other/title/title_logo/title_logo.tscn")
var title = preload("res://objects/title/title.tscn")
var bricks = preload("res://objects/bricks/bricks.tscn")
var game = preload("res://objects/game/game.tscn")
var copy = preload("res://objects/other/title/copy/copy.tscn")

var scenes_with_id = {}
var tile_map = TileMap.new()
var layer = 0

var last_object = ''

func _input(event):
	if Input.is_key_pressed(KEY_0):
		gml.tile_add('bg_cave_top', 0, 0, 16, 16, 128, 128, 500)
		print('add')

# Called when the node enters the scene tree for the first time.
func _ready():

	tile_map.position.x = -8
	tile_map.position.y = -8
	var tile_set = TileSet.new()
	tile_map.tile_set = tile_set
	var tile_set_source = TileSetScenesCollectionSource.new()
	tile_set.add_source(tile_set_source)
	
	var i = 0
	
	for scene in title_scenes:
		print(scene)
		i += 1
		tile_set_source.create_scene_tile(scene)
		print(scene._bundled.names)
		print(scene._bundled.names[3])
		if !scenes_with_id.has(scene._bundled.names[0].to_snake_case()):
			scenes_with_id[scene._bundled.names[0].to_snake_case()] = i
	
	scenes_with_id["x_shortcut5"] = 4
	scenes_with_id["level5_sign"] = 9
	
	#await get_tree().create_timer(2).timeout
	add_child(tile_map)
	tile_map.owner = get_tree().edited_scene_root
	print("for test")
	print(tile_set_source.get_tiles_count())
	
	var keys = scenes_with_id.keys()
	var number_of_scenes = keys.size()
	
	for num in number_of_scenes:
		tile_map.add_layer(num)
	
	
#region Instance Tiles
	gml.instance_create(384, 48, title_bg)
	gml.instance_create(384, 176, x_start)
	gml.instance_create(432, 176, x_scores)
	gml.instance_create(80, 128, x_shortcut5)
	gml.instance_create(336, 176, x_tutorial)
	gml.instance_create(560, 16, quit_sign)
	gml.instance_create(416, 160, scores_sign)
	gml.instance_create(368, 160, start_sign)
	gml.instance_create(64, 112, level5_sign)
	gml.instance_create(320, 160, tutorial_sign)
	gml.instance_create(592, 0, rope)
	gml.instance_create(592, 8, rope)
	gml.instance_create(592, 16, rope)
	gml.instance_create(592, 24, rope)
	gml.instance_create(592, 32, rope)
	gml.instance_create(592, 40, rope)
	gml.instance_create(592, 48, rope)
	gml.instance_create(592, 56, rope)
	gml.instance_create(592, 64, rope)
	gml.instance_create(592, 72, rope)
	gml.instance_create(592, 80, rope)
	gml.instance_create(592, 88, rope)
	gml.instance_create(592, 96, rope)
	gml.instance_create(592, 104, rope)
	gml.instance_create(592, 112, rope)
	gml.instance_create(592, 120, rope)
	gml.instance_create(592, 128, rope)
	gml.instance_create(592, 136, rope)
	gml.instance_create(592, 144, rope)
	gml.instance_create(592, 152, rope)
	gml.instance_create(592, 160, rope)
	gml.instance_create(240, 144, brick_smooth)
	gml.instance_create(224, 144, brick_smooth)
	gml.instance_create(208, 144, brick_smooth)
	gml.instance_create(192, 144, brick_smooth)
	gml.instance_create(176, 144, brick_smooth)
	gml.instance_create(160, 144, brick_smooth)
	gml.instance_create(144, 144, brick_smooth)
	gml.instance_create(128, 144, brick_smooth)
	gml.instance_create(112, 144, brick_smooth)
	gml.instance_create(96, 144, brick_smooth)
	gml.instance_create(80, 144, brick_smooth)
	gml.instance_create(64, 144, brick_smooth)
	gml.instance_create(48, 144, brick_smooth)
	gml.instance_create(32, 144, brick_smooth)
	gml.instance_create(288, 112, brick_smooth)
	gml.instance_create(272, 112, brick_smooth)
	gml.instance_create(304, 112, brick_smooth)
	gml.instance_create(256, 128, brick_smooth)
	gml.instance_create(16, 192, brick)
	gml.instance_create(32, 192, brick)
	gml.instance_create(48, 192, brick)
	gml.instance_create(64, 192, brick)
	gml.instance_create(80, 192, brick)
	gml.instance_create(96, 192, brick)
	gml.instance_create(112, 192, brick)
	gml.instance_create(128, 192, brick)
	gml.instance_create(144, 192, brick)
	gml.instance_create(160, 192, brick)
	gml.instance_create(176, 192, brick)
	gml.instance_create(192, 192, brick)
	gml.instance_create(208, 192, brick)
	gml.instance_create(224, 192, brick)
	gml.instance_create(240, 192, brick)
	gml.instance_create(256, 192, brick)
	gml.instance_create(272, 192, brick)
	gml.instance_create(288, 192, brick)
	gml.instance_create(288, 128, brick)
	gml.instance_create(288, 144, brick)
	gml.instance_create(288, 160, brick)
	gml.instance_create(288, 176, brick)
	gml.instance_create(288, 16, brick)
	gml.instance_create(288, 16, brick)
	gml.instance_create(288, 32, brick)
	gml.instance_create(288, 48, brick)
	gml.instance_create(288, 64, brick)
	gml.instance_create(16, 112, brick)
	gml.instance_create(32, 16, brick)
	gml.instance_create(64, 16, brick)
	gml.instance_create(80, 16, brick)
	gml.instance_create(96, 16, brick)
	gml.instance_create(112, 16, brick)
	gml.instance_create(128, 16, brick)
	gml.instance_create(144, 16, brick)
	gml.instance_create(160, 16, brick)
	gml.instance_create(176, 16, brick)
	gml.instance_create(192, 16, brick)
	gml.instance_create(208, 16, brick)
	gml.instance_create(224, 16, brick)
	gml.instance_create(304, 16, hard_block)
	gml.instance_create(304, 32, hard_block)
	gml.instance_create(304, 48, hard_block)
	gml.instance_create(304, 64, hard_block)
	gml.instance_create(304, 80, hard_block)
	gml.instance_create(304, 128, hard_block)
	gml.instance_create(304, 144, hard_block)
	gml.instance_create(304, 160, hard_block)
	gml.instance_create(304, 176, hard_block)
	gml.instance_create(304, 192, hard_block)
	gml.instance_create(32, 64, brick)
	gml.instance_create(32, 48, brick)
	gml.instance_create(32, 32, brick)
	gml.instance_create(48, 32, brick)
	gml.instance_create(48, 48, brick)
	gml.instance_create(64, 32, brick)
	gml.instance_create(320, 192, brick)
	gml.instance_create(592, 208, brick)
	gml.instance_create(368, 208, brick)
	gml.instance_create(320, 208, brick)
	gml.instance_create(336, 208, brick)
	gml.instance_create(352, 208, brick)
	gml.instance_create(384, 208, brick)
	gml.instance_create(464, 208, brick)
	gml.instance_create(480, 208, brick)
	gml.instance_create(496, 208, brick)
	gml.instance_create(512, 208, brick)
	gml.instance_create(528, 208, brick)
	gml.instance_create(544, 208, brick)
	gml.instance_create(560, 208, brick)
	gml.instance_create(576, 208, brick)
	gml.instance_create(608, 208, brick)
	gml.instance_create(608, 192, brick)
	gml.instance_create(592, 192, brick)
	gml.instance_create(576, 192, brick)
	gml.instance_create(560, 192, brick)
	gml.instance_create(544, 192, brick)
	gml.instance_create(528, 192, brick)
	gml.instance_create(512, 192, brick)
	gml.instance_create(496, 192, brick)
	gml.instance_create(480, 192, brick)
	gml.instance_create(464, 192, brick)
	gml.instance_create(448, 192, brick)
	gml.instance_create(448, 208, brick)
	gml.instance_create(432, 208, brick)
	gml.instance_create(416, 208, brick)
	gml.instance_create(400, 208, brick)
	gml.instance_create(336, 192, brick)
	gml.instance_create(352, 192, brick)
	gml.instance_create(368, 192, brick)
	gml.instance_create(384, 192, brick)
	gml.instance_create(400, 192, brick)
	gml.instance_create(416, 192, brick)
	gml.instance_create(432, 192, brick)
	gml.instance_create(320, 16, brick)
	gml.instance_create(320, 32, brick)
	gml.instance_create(320, 48, brick)
	gml.instance_create(320, 64, brick)
	gml.instance_create(320, 80, brick)
	gml.instance_create(320, 112, brick)
	gml.instance_create(320, 128, brick)
	gml.instance_create(320, 144, brick)
	gml.instance_create(320, 176, brick)
	gml.instance_create(336, 144, brick)
	gml.instance_create(336, 128, brick)
	gml.instance_create(336, 112, brick)
	gml.instance_create(336, 80, brick)
	gml.instance_create(336, 64, brick)
	gml.instance_create(336, 48, brick)
	gml.instance_create(336, 32, brick)
	gml.instance_create(336, 16, brick)
	gml.instance_create(288, 80, brick)
	gml.instance_create(352, 16, brick)
	gml.instance_create(368, 16, brick)
	gml.instance_create(384, 16, brick)
	gml.instance_create(400, 16, brick)
	gml.instance_create(416, 16, brick)
	gml.instance_create(432, 16, brick)
	gml.instance_create(448, 16, brick)
	gml.instance_create(464, 16, brick)
	gml.instance_create(480, 16, brick)
	gml.instance_create(512, 16, brick)
	gml.instance_create(496, 16, brick)
	gml.instance_create(528, 16, brick)
	gml.instance_create(544, 16, brick)
	gml.instance_create(608, 16, brick)
	gml.instance_create(608, 32, brick)
	gml.instance_create(608, 48, brick)
	gml.instance_create(608, 64, brick)
	gml.instance_create(608, 80, brick)
	gml.instance_create(608, 96, brick)
	gml.instance_create(608, 112, brick)
	gml.instance_create(608, 128, brick)
	gml.instance_create(608, 144, brick)
	gml.instance_create(608, 160, brick)
	gml.instance_create(608, 176, brick)
	gml.instance_create(576, 32, brick)
	gml.instance_create(576, 48, brick)
	gml.instance_create(576, 64, brick)
	gml.instance_create(560, 48, brick)
	gml.instance_create(560, 32, brick)
	gml.instance_create(544, 32, brick)
	gml.instance_create(352, 32, brick)
	gml.instance_create(352, 48, brick)
	gml.instance_create(352, 64, brick)
	gml.instance_create(384, 32, brick)
	gml.instance_create(368, 32, brick)
	gml.instance_create(368, 48, brick)
	gml.instance_create(192, 208, brick)
	gml.instance_create(208, 208, brick)
	gml.instance_create(304, 208, brick)
	gml.instance_create(288, 208, brick)
	gml.instance_create(272, 208, brick)
	gml.instance_create(256, 208, brick)
	gml.instance_create(240, 208, brick)
	gml.instance_create(224, 208, brick)
	gml.instance_create(176, 208, brick)
	gml.instance_create(160, 208, brick)
	gml.instance_create(144, 208, brick)
	gml.instance_create(128, 208, brick)
	gml.instance_create(112, 208, brick)
	gml.instance_create(96, 208, brick)
	gml.instance_create(80, 208, brick)
	gml.instance_create(64, 208, brick)
	gml.instance_create(48, 208, brick)
	gml.instance_create(32, 208, brick)
	gml.instance_create(16, 208, brick)
	gml.instance_create(16, 16, brick)
	gml.instance_create(16, 32, brick)
	gml.instance_create(16, 48, brick)
	gml.instance_create(16, 64, brick)
	gml.instance_create(16, 80, brick)
	gml.instance_create(16, 96, brick)
	gml.instance_create(240, 16, brick)
	gml.instance_create(256, 16, brick)
	gml.instance_create(272, 16, brick)
	gml.instance_create(272, 32, brick)
	gml.instance_create(272, 128, brick)
	gml.instance_create(272, 144, brick)
	gml.instance_create(272, 160, brick)
	gml.instance_create(272, 176, brick)
	gml.instance_create(256, 176, brick)
	gml.instance_create(256, 160, brick)
	gml.instance_create(256, 144, brick)
	gml.instance_create(16, 144, brick)
	gml.instance_create(16, 160, brick)
	gml.instance_create(32, 160, brick)
	gml.instance_create(48, 160, brick)
	gml.instance_create(64, 160, brick)
	gml.instance_create(80, 160, brick)
	gml.instance_create(96, 160, brick)
	gml.instance_create(112, 160, brick)
	gml.instance_create(128, 160, brick)
	gml.instance_create(144, 160, brick)
	gml.instance_create(160, 160, brick)
	gml.instance_create(176, 160, brick)
	gml.instance_create(192, 160, brick)
	gml.instance_create(208, 160, brick)
	gml.instance_create(224, 160, brick)
	gml.instance_create(240, 160, brick)
	gml.instance_create(240, 176, brick)
	gml.instance_create(224, 176, brick)
	gml.instance_create(208, 176, brick)
	gml.instance_create(192, 176, brick)
	gml.instance_create(176, 176, brick)
	gml.instance_create(160, 176, brick)
	gml.instance_create(144, 176, brick)
	gml.instance_create(128, 176, brick)
	gml.instance_create(112, 176, brick)
	gml.instance_create(96, 176, brick)
	gml.instance_create(80, 176, brick)
	gml.instance_create(64, 176, brick)
	gml.instance_create(48, 176, brick)
	gml.instance_create(32, 176, brick)
	gml.instance_create(16, 176, brick)
	gml.instance_create(48, 64, brick)
	gml.instance_create(64, 48, brick)
	gml.instance_create(80, 32, brick)
	gml.instance_create(48, 16, brick)
	gml.instance_create(0, 0, hard_block)
	gml.instance_create(16, 0, hard_block)
	gml.instance_create(32, 0, hard_block)
	gml.instance_create(48, 0, hard_block)
	gml.instance_create(64, 0, hard_block)
	gml.instance_create(80, 0, hard_block)
	gml.instance_create(96, 0, hard_block)
	gml.instance_create(112, 0, hard_block)
	gml.instance_create(128, 0, hard_block)
	gml.instance_create(144, 0, hard_block)
	gml.instance_create(160, 0, hard_block)
	gml.instance_create(176, 0, hard_block)
	gml.instance_create(192, 0, hard_block)
	gml.instance_create(208, 0, hard_block)
	gml.instance_create(224, 0, hard_block)
	gml.instance_create(240, 0, hard_block)
	gml.instance_create(256, 0, hard_block)
	gml.instance_create(272, 0, hard_block)
	gml.instance_create(288, 0, hard_block)
	gml.instance_create(304, 0, hard_block)
	gml.instance_create(320, 0, hard_block)
	gml.instance_create(336, 0, hard_block)
	gml.instance_create(352, 0, hard_block)
	gml.instance_create(368, 0, hard_block)
	gml.instance_create(384, 0, hard_block)
	gml.instance_create(400, 0, hard_block)
	gml.instance_create(416, 0, hard_block)
	gml.instance_create(432, 0, hard_block)
	gml.instance_create(448, 0, hard_block)
	gml.instance_create(464, 0, hard_block)
	gml.instance_create(480, 0, hard_block)
	gml.instance_create(496, 0, hard_block)
	gml.instance_create(512, 0, hard_block)
	gml.instance_create(528, 0, hard_block)
	gml.instance_create(544, 0, hard_block)
	gml.instance_create(560, 0, hard_block)
	gml.instance_create(576, 0, hard_block)
	gml.instance_create(608, 0, hard_block)
	gml.instance_create(624, 0, hard_block)
	gml.instance_create(624, 16, hard_block)
	gml.instance_create(624, 32, hard_block)
	gml.instance_create(624, 48, hard_block)
	gml.instance_create(624, 64, hard_block)
	gml.instance_create(624, 80, hard_block)
	gml.instance_create(624, 96, hard_block)
	gml.instance_create(624, 112, hard_block)
	gml.instance_create(624, 128, hard_block)
	gml.instance_create(624, 144, hard_block)
	gml.instance_create(624, 160, hard_block)
	gml.instance_create(624, 176, hard_block)
	gml.instance_create(624, 192, hard_block)
	gml.instance_create(624, 208, hard_block)
	gml.instance_create(624, 224, hard_block)
	gml.instance_create(608, 224, hard_block)
	gml.instance_create(592, 224, hard_block)
	gml.instance_create(576, 224, hard_block)
	gml.instance_create(560, 224, hard_block)
	gml.instance_create(544, 224, hard_block)
	gml.instance_create(528, 224, hard_block)
	gml.instance_create(512, 224, hard_block)
	gml.instance_create(496, 224, hard_block)
	gml.instance_create(480, 224, hard_block)
	gml.instance_create(464, 224, hard_block)
	gml.instance_create(448, 224, hard_block)
	gml.instance_create(432, 224, hard_block)
	gml.instance_create(416, 224, hard_block)
	gml.instance_create(400, 224, hard_block)
	gml.instance_create(384, 224, hard_block)
	gml.instance_create(368, 224, hard_block)
	gml.instance_create(352, 224, hard_block)
	gml.instance_create(336, 224, hard_block)
	gml.instance_create(320, 224, hard_block)
	gml.instance_create(304, 224, hard_block)
	gml.instance_create(288, 224, hard_block)
	gml.instance_create(272, 224, hard_block)
	gml.instance_create(256, 224, hard_block)
	gml.instance_create(240, 224, hard_block)
	gml.instance_create(224, 224, hard_block)
	gml.instance_create(208, 224, hard_block)
	gml.instance_create(192, 224, hard_block)
	gml.instance_create(176, 224, hard_block)
	gml.instance_create(160, 224, hard_block)
	gml.instance_create(144, 224, hard_block)
	gml.instance_create(128, 224, hard_block)
	gml.instance_create(112, 224, hard_block)
	gml.instance_create(96, 224, hard_block)
	gml.instance_create(80, 224, hard_block)
	gml.instance_create(64, 224, hard_block)
	gml.instance_create(48, 224, hard_block)
	gml.instance_create(32, 224, hard_block)
	gml.instance_create(16, 224, hard_block)
	gml.instance_create(0, 224, hard_block)
	gml.instance_create(0, 208, hard_block)
	gml.instance_create(0, 192, hard_block)
	gml.instance_create(0, 176, hard_block)
	gml.instance_create(0, 160, hard_block)
	gml.instance_create(0, 144, hard_block)
	gml.instance_create(0, 128, hard_block)
	gml.instance_create(0, 112, hard_block)
	gml.instance_create(0, 96, hard_block)
	gml.instance_create(0, 80, hard_block)
	gml.instance_create(0, 64, hard_block)
	gml.instance_create(0, 48, hard_block)
	gml.instance_create(0, 32, hard_block)
	gml.instance_create(0, 16, hard_block)
	gml.instance_create(16, 128, brick)
	gml.instance_create(416, 80, title_logo)
	gml.instance_create(112, 32, game)
	gml.instance_create(96, 32, title)
	gml.instance_create(128, 32, bricks)
	gml.instance_create(408, 224, copy)
#endregion

	#$TileMap.create_scene_tile("res://objects/other/intro/moon/moon.tscn")
	#TileSetScenesCollectionSource

# Called every frame. 'delta' is the elapsed time since the previous frame.

	for layer in tile_map.get_layers_count():
		print(layer)
		print(tile_map.get_used_cells(layer))
	
	print(tile_map.get_cell_source_id(0, Vector2i(24, 3)))

func add_tile(x, y, name):
	var id = scenes_with_id[name]
	var tile_x = 0
	var tile_y = 0
	
	if x != 0:
		tile_x = x / 16
	if y!= 0:
		tile_y = y / 16
		
	tile_map.set_cell(layer, Vector2i(tile_x, tile_y), 0, Vector2i(0, 0), id)
	
	if last_object != name:
		last_object = name
		layer += 1
	
func _process(delta):
	pass
